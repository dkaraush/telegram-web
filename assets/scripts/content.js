var contentContainer=$("#content");function openPeer(a){if(!(0<=contentContainer.className.indexOf(a.id))){openingPeer=!0;var b=$("#content ."+contentContainer.className);b&&(b.style.display="none");b=$("#content ."+a.id);b||(createPeerWindow(a),b=$("#content ."+a.id),contentContainer.appendChild(b));b.style.display="block";contentContainer.className=a.id}}var peerListeners=[];
function svg(a,b){var c=$doc.createElementNS("http://www.w3.org/2000/svg","svg"),e=$doc.createElementNS("http://www.w3.org/2000/svg","use");e.setAttributeNS("http://www.w3.org/1999/xlink","href","#"+a);"corner"!=a?(c.setAttribute("height",24),c.setAttribute("width",24),b&&(c.className.baseVal=b)):c.className.baseVal="corner";c.setAttribute("viewBox","corner"==a?"15 12 11 20":"0 0 24 24");c.appendChild(e);return c}
function lastSeen(a){var b=Math.abs(Date.now()/1E3-a);if(60>b)return"just now";if(3600>b){var c=Math.floor(b/60);return c+" minute"+(1<c?"s":"")+" ago"}if(86400>b)return c=Math.floor(b/3600),c+" hour"+(1<c?"s":"")+" ago";c=new Date(1E3*a);a=c.getDate();b=c.getMonth()+1;var e=c.getFullYear()-2E3,d=c.getHours();c=c.getMinutes();10>a&&(a="0"+a);10>b&&(b="0"+b);10>d&&(d="0"+d);10>c&&(c="0"+c);return[d,c].join(":")+" "+[b,a,e].join(".")}
function userStatus(a){if(!a||"userStatusEmpty"==a._)return[];if("userStatusOnline"==a._)return"online";if("userStatusOffline"==a._)return"last seen "+lastSeen(a.was_online);if("userStatusRecently"==a._)return"last seen recently";if("userStatusLastWeek"==a._)return"last seen last week";if("userStatusLastMonth"==a._)return"last seen last month"}
function createPeerWindow(a){function b(a,b){console.log("updateMessages()");var e=g.scrollHeight,d="#"+a.id+"-",p;for(p in a.messages){var m=parseInt(p);if(0>n.indexOf(m)){var f=messageElement(a.messages[p],a);if(f)if(0==l.childElementCount)l.appendChild(f),n.push(m);else{var h=binSearch(n,m),k=n[h];if(null!=k){var q=$(d+k);k<m&&(q=q.nextSibling);l.insertBefore(f,q);n.splice(h+(k<m?1:0),0,m)}}}}if(b)for(h=0;h<b.length;++h)$(d+b[h])&&$(d+b[h]).remove();g.scrollTop+=g.scrollHeight-e;$n(function(){0<=
$("#content").className.indexOf(a.id)&&c(!0)})}function c(b){console.log("checkHoles()");if(a.loadingHole)console.log("peer loades hole");else if(!(200>Date.now()-r)||b){b="#"+a.id+"-";for(var c=0;c<a.holes.length;++c){var d=$(b+a.holes[c].id);if(d&&isAnyPartOfElementInViewport(d)){a.loadHole(c);break}}r=Date.now()}}function e(b,c){if(f&&k){var d=f.value.trim();if((b||13==c.keyCode&&!c.ctrlKey&&!c.metaKey)&&0<d.length){var e=d;call("messages.sendMessage",{peer:a.inputPeer,message:e,random_id:randomBytes(8),
clear_draft:!0},function(b,c){b&&"updateShortSentMessage"==c._&&(c._="message",c.from_id=auth.user.id,c.message=e,a.putMessages([c],!0))});f.value=d="";$n(function(){f.value=""})}else 13==c.keyCode&&c.metaKey&&(f.value+="\n",f.focus());f.style.height="auto";f.style.height=range(f.scrollHeight-4,24,128)+"px";$setclass(k,"voice",0==d.length);$setclass(k,"msg",0<d.length)}}var d,l,g,h,f,k,n=[],t=a.user||a.chat;peerListeners.push(a.id+"-"+a.listenDialog(function(b){var c=d.querySelector(".picture"),e=
b.chat||b.user;e.photo&&e.photo.smallLoaded&&null==c.querySelector("img")&&(e=_peerImage(b),c.appendChild(e));b.chat?h.innerText=null==a.chat.membersCount?"":a.chat.membersCount.toLocaleString()+" members":($setclass(h,"online",b.user.status&&"userStatusOnline"==b.user.status._),h.innerText=userStatus(b.user.status))}));peerListeners.push(a.id+"-"+a.listenMessages(b));var r=-1,u="C"!=a.type||a.chat&&a.chat.creator;$("#content > div").appendChild(d=$new("div."+a.id+(u?".hasInput":""),null,[$new("div.header",
null,[$new("div.picture",null,peerImage(a)),$new("div.info",null,[$new("h2",t.title,[t.verified?svg("verified","verified"):null]),h=$new("p"+(a.user&&a.user.status&&"userStatusOnline"==a.user.status._?".online":""),a.chat?null==a.chat.membersCount?"":a.chat.membersCount+" members":userStatus(a.user.status))])]),$new("div.content",null,[g=$new("div.messages",null,[$new("div",null,[l=$new("div")])],$evt(["scroll"],c)),u?$new("div.sendbox",null,[$new("div",null,[$new("div.gradient"),$new("div.inputbox",
null,[$new("div.emoji-select",null,[svg("emoji-select")],UI.addRipple),$new("div.text",null,[f=$new("textarea",{rows:1,placeholder:"Message","max-rows":10},[],$evt(["click","keyup","keypress","keydown","change"],e.bind(this,!1)))]),$new("div.attach",null,[svg("attach")],UI.addRipple),svg("corner")]),k=$new("div.btn.voice",null,[$new("div.voice",null,[svg("mic")]),$new("div.msg",null,[svg("send")])],UI.addRipple,$click(e.bind(this,!0)))])]):null])]));a.chat&&!a.chat.infoLoaded&&a.chat.loadInfo();b(a);
0==a.holes.length&&a.load();g.scrollTop=g.scrollHeight}function isAnyPartOfElementInViewport(a){a=a.getBoundingClientRect();var b=$win.innerWidth||$doc.documentElement.clientWidth;return a.top<=($win.innerHeight||$doc.documentElement.clientHeight)&&0<=a.top+a.height&&a.left<=b&&0<=a.left+a.width}function dateToTimeString(a){var b=new Date(1E3*a);a=b.getHours();b=b.getMinutes();10>a&&(a="0"+a);10>b&&(b="0"+b);return a+":"+b}var emptyPhoto="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D";
function messageElement(a,b){if("message"==a._){var c=a.media&&"photo"==a.media.type,e=c&&0==a.message.length,d=!a.pFlags.out&&"c"==b.type&&users[a.from_id],l="number"===typeof a.views,g;c&&(a.media.onUpdate=function(){g&&(g.src=a.media.previewSrc,g.className="photo")});return $new("div"+(a.pFlags.out?".out":".in")+(e?".photo":"")+(d?".usertitle":"")+(l?".views":"")+"#"+b.id+"-"+a.id,null,[$new("span",null,[d?$new("h2",users[a.from_id].title,[],function(b){b.style.color=userColors[parseInt(users[a.from_id].id)%
userColors.length]}):null,"undefined"!==typeof a.reply_to_msg_id&&b.messages[a.reply_to_msg_id]&&users[b.messages[a.reply_to_msg_id].from_id]?$new("span.reply",null,[$new("h2",users[b.messages[a.reply_to_msg_id].from_id].title),$new("span",shorttext(b.messages[a.reply_to_msg_id].message,25))],UI.addRipple):null,c?$new("span.photo"+(null==a.media.previewSrc?".loading":""),null,[g=$new("img",assign({width:a.media.previewSize.w/window.devicePixelRatio,height:a.media.previewSize.h/window.devicePixelRatio,
src:a.media.previewSrc||emptyPhoto}),null,function(a){})]):null,$new("span",a.message),$new("div",null,[l?$new("span.views",null,[svg("eye"),$new("span",a.views.toLocaleString())]):null,$new("span.time",dateToTimeString(a.date))]),e?null:svg("corner")])])}if("messageService"==a._)return $new("div.sys#"+b.id+"-"+a.id,null,[$new("span",messageServiceContent(a,b))])}function correct(a,b,c){return a[b]==c?(console.warn("WTF???"),!0):a[b]<c&&(b==a.length-1||a[b+1]>c)||a[b]>c&&(0==b||a[b-1]<c)}
function binsrch(a,b,c,e){if(b==c)return correct(a,b,e)?b:null;var d=~~(b+(c-b+1)/2);if(correct(a,d,e))return d;if(a[d]>e)return binsrch(a,b,d-1,e);if(a[d]<e)return binsrch(a,d+1,c,e);console.warn("WTF 2???");return null}function binSearch(a,b){return binsrch(a,0,a.length-1,b)};