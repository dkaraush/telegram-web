var ids={u:"user_id",C:"channel_id",c:"chat_id"},peerType={peerUser:"u",peerChannel:"C",peerChat:"c"},peerName={u:"peerUser",C:"peerChannel",c:"peerChat"},inputPeerName={u:"inputPeerUser",C:"inputPeerChannel",c:"inputPeerChat"};function peerID(a){return peerType[a._]+a[ids[peerType[a._]]]}
var ext={},ExternalMTProto=MTProto.extend({constructor:function(a){var b=this;this.id=S(a.photo_id);this._super(a);this.before=function(a){function c(c){b.sendAPIMethod("auth.importAuthorization",{id:c.id,bytes:c.bytes},function(c,e){c&&"auth.authorization"==e._?a():b.warn("failed to import authorization",e)},!0)}proto.sendAPIMethod("auth.exportAuthorization",{dc_id:b.DC},function(a,d){a&&"auth.exportedAuthorization"==d._?c(d):b.warn("failed to export authorization",d)})};this.connect()}}),ProfilePhoto=
Class.extend({constructor:function(a,b,c){this.conn=proto;this.dc_id=a.dc_id||2;this.size=this.filename=null;this.isAnimatedSticker=this.isSticker=!1;this.onUpdate=c;this.inputPeer=b;this.src=this.blob=null;0<=a._.toLowerCase().indexOf("empty")||(this.volume_id=a.photo_small.volume_id,this.local_id=a.photo_small.local_id,this.load())},load:function(){var a=this;loadDeprecatedLocation(this.dc_id,{_:"inputPeerPhotoFileLocation",peer:this.inputPeer,local_id:this.local_id,volume_id:this.volume_id},function(b,
c){a.blob=b;a.src=c;if("function"===typeof a.onUpdate)a.onUpdate()})}});function title(a){return a&&"user"==a._?a.first_name+(a.last_name?" "+a.last_name:""):a?a.title:""}
var Media=Class.extend({constructor:function(a,b,c){this.onUpdate=null;this.type=a._.slice(12).toLowerCase();this.raw=a;this.message=b;this.peer=c;this.ready=!0;"empty"!=this.type&&"photo"==this.type&&(this.photoRaw=a.photo,"photoEmpty"!=this.photoRaw._&&(this.photo=this.photoRaw,this.photo.src=null,this.photo.previewSrc=null,this.ready=!1,this.loadPreviewPhoto()))},loadPreviewPhoto:function(){for(var a=this.photo.sizes,b=map(a,function(a){return a.type}),c=null,d=0;9>d;++d)if(0<=b.indexOf("xmyswabcd"[d])){c=
a[b.indexOf("xmyswabcd"[d])];break}if(null==c)console.warn("size for preview not found");else if(this.previewSize=c,c.location){var e=this;loadDeprecatedLocation(this.photo.dc_id,{_:"inputPhotoFileLocation",access_hash:this.photo.access_hash,file_reference:this.photo.file_reference,thumb_size:c.type,id:this.photo.id},function(a,b){e.previewSrc=b;e.previewBlob=a;if("function"===typeof e.onUpdate)e.onUpdate()})}else console.warn("location in size object is missing")},loadPhoto:function(){}});
function loadDeprecatedLocation(a,b,c){if(a==proto.DC)var d=proto;else proto.DC==a||ext[a]?a!=proto.DC&&ext[a]&&(d=ext[a]):(ext[a]=new ExternalMTProto({debug:!0,DC:a}),d=ext[a]);d.sendAPIMethod("upload.getFile",{location:b,offset:0,limit:1048576},function(a,b){if(a){if("upload.file"==b._){var d=new Blob([b.bytes]),e=URL.createObjectURL(d);c(d,e)}}else console.warn("upload.getFile: bad response")})}
var chats={},users={},User=Class.extend({constructor:function(a,b){this.peers=b?[b]:[];this.id=a.id;this.access_hash=a.access_hash;a.pFlags.deleted?(this.title="Deleted Account",this["short"]=":(",this.photo=null):(this.title=title(a),this["short"]=a.last_name?(a.first_name[0]+a.last_name[0]).toUpperCase():a.first_name[0].toUpperCase(),this.phone=a.phone||!1,this.photo=a.photo&&"chatPhotoEmpty"!=a.photo._?new ProfilePhoto(a.photo,{_:"inputPeerUser",user_id:this.id,access_hash:this.access_hash},this.update.bind(this)):
null,this.status=a.status);this.verified=a.pFlags?a.pFlags.verified:!1;this.raw=a},addPeer:function(a){this.peers.push(a)},forgetPeer:function(a){for(var b=0;b<this.peers.length;++b)this.peers[b].id==a.id&&(this.peers.splice(b,1),b--)},updInfo:function(a){this.update()},update:function(){for(var a=0;a<this.peers.length;++a)this.peers[a].update()}}),Chat=Class.extend({constructor:function(a,b){this.peers=b?[b]:[];this.id=a.id;this.access_hash=a.access_hash||null;this.title=title(a);this["short"]=1<
this.title.split(" ").length?map(this.title.split(" ").slice(0,2),function(a){return a[0]}).join("").toUpperCase():this.title.slice(0,2).toUpperCase();this.creator=a.pFlags?a.pFlags.creator:!1;this.isChat="chat"==a._;this.isChannel="channel"==a._;var c;"chat"==a._?c={_:"inputPeerChat",chat_id:a.id,access_hash:this.access_hash}:"channel"==a._&&(c={_:"inputPeerChannel",channel_id:a.id,access_hash:this.access_hash});this.photo=a.photo&&c?new ProfilePhoto(a.photo,c,this.update.bind(this)):null;this.raw=
a;this.members=null;this.membersCount=a.participants_count||null;this.status=null;this.verified=a.pFlags?a.pFlags.verified:!1;this.infoLoaded=!1;this.info=null},addPeer:function(a){this.peers.push(a)},forgetPeer:function(a){for(var b=0;b<this.peers.length;++b)this.peers[b].id==a.id&&(this.peers.splice(b,1),b--)},update:function(){for(var a=0;a<this.peers.length;++a)this.peers[a].update()},updInfo:function(a){},loadInfo:function(){if(!this.infoLoaded){console.log("loading info");var a=this;call(this.isChat?
"messages.getFullChat":"channels.getFullChannel",{chat_id:this.id,channel:{_:"inputChannel",channel_id:this.id,access_hash:this.access_hash}},function(b,c){b?(console.log("info loaded: ",c),a.infoLoaded=!0,c.users&&pushUsers(c.users),c.chats&&pushChats(c.chats),a.info=c.full_chat,a.membersCount=a.info.participants_count?a.info.participants_count:a.info.participants.length,a.update()):console.warn("failed to load chat/channel info")})}}}),Peer=Class.extend({constructor:function(a,b){this.onDialogUpdate=
{};this.onMessagesUpdate={};this.type=peerType[a._];this.id=peerID(a);"undefined"===typeof peers[this.id]&&(peers[this.id]=this);this.access_hash=null;this.messages={};this.messagesCount=-1;this.holes=[];b&&this.obtainInfo(b);this.inputPeer=this._inputPeer();b.channel&&b.channel.raw.pFlags.megagroup&&(this.type="c")},load:function(){this.loadHole()},loadHole:function(a){if("undefined"===typeof a)var b={offset_id:0,offset_date:0,add_offset:0,max_id:0,min_id:0,hash:0,limit:20};else b=this.holes[a],
b={offset_id:b.id,offset_date:0,add_offset:b.dir?0:-20,limit:20,max_id:0,min_id:0,hash:0};var c=this;c.loadingHole=!0;call("messages.getHistory",assign({peer:this.inputPeer},b),function(b,e){if(b)c.loadingHole=!1,c.receiveHistory(a,e);else if("FLOOD_WAIT_"==e.error_message.slice(0,11)){var d=parseInt(e.error_message.slice(11));console.warn("getHistory: FLOOD (waiting "+d+" seconds)");$t(1E3*d,c.loadHole.bind(c,a))}else c.loadingHole=!1})},receiveHistory:function(a,b){b.users&&pushUsers(b.users);if(b.messages){b.count&&
(this.messagesCount=b.count);this.putMessages(b.messages);"undefined"===typeof a&&(this.holes.push({id:b.messages[b.messages.length-1].id,dir:!0}),a=this.holes.length-1);for(var c=this.holes[a],d=0;d<this.holes.length;++d)if(d!=a)for(var e=0;e<b.messages.length;++e)b.messages[e].id==this.holes[d].id&&(this.holes[d].dir?e!=b.messages.length-1:0!=e)&&(this.holes.splice(d,1),d--);c&&c.dir&&0<b.messages.length?0!=b.messages[b.messages.length-1].id&&Object.keys(this.messages).length!=this.messagesCount&&
this.holes.push({id:b.messages[b.messages.length-1].id,dir:!0}):c&&!c.dir&&0<b.messages.length&&b.messages[0].id!=this.top_message&&Object.keys(this.messages).length!=this.messagesCount&&this.holes.push({id:b.messages[0].id,dir:!1});if(c)for(d=0;d<this.holes.length;++d)this.holes[d].id==c.id&&this.holes[d].dir==c.dir&&this.holes.splice(d,1);this.update()}},processMessage:function(a){a.media&&(a.mediaRaw=a.media,a.media=new Media(a.media,a,this));return a},putMessages:function(a,b,c,d){for(var e=0;e<
a.length;++e){var g=this.processMessage(a[e]);this.messages[a[e].id]=g;g.id>this.top_message&&(this.top_message=g.id)}c&&this.holes.push({dir:!0,id:a[0].id});d&&this.holes.push({dir:!1,id:a[a.length-1].id});b&&this.update()},deleteMessages:function(a){for(var b=0;b<a.length;++b)delete this.messages[a[b]];for(b=0;b<a.length;++b)for(var c=0;c<this.holes.length;++c){var d=this.holes[c];if(d.id==a[b])for(var e=d.id;d.dir?0<=e:e<=this.top_message;d.dir?e--:e++)if(this.messages[e]){this.holes[c].id=e;break}}this.update(a)},
update:function(a){for(var b in this.onDialogUpdate)this.onDialogUpdate[b](this,a);for(b in this.onMessagesUpdate)this.onMessagesUpdate[b](this,a)},_inputPeer:function(){var a={_:inputPeerName[this.type]},b=this.id.slice(1);a[ids[this.type]]=parseInt(b);null!=this.access_hash&&(a.access_hash=this.access_hash);return a},updateAsDialog:function(a){this.obtainInfo(a)},obtainInfo:function(a){this.unread=a.unread_count;this.unread_mentions=a.unread_mentions_count;this.top_message=a.top_message||-1;a.user&&
(this.user&&this.user.id!=a.user.id&&this.user.forgetPeer(this),this.user&&this.user.id==a.user.id||(this.user=a.user,this.user.addPeer(this)),this.access_hash=a.user.access_hash);if(a.channel||a.chat){var b=a.channel||a.chat;this.chat&&this.chat.id!=b.id&&this.chat.forgetPeer(this);this.chat&&this.chat.id==b.id||(this.chat=b,this.chat.addPeer(this));this.access_hash=(a.channel||a.chat).access_hash}a.message&&(this.messages[this.top_message]=this.processMessage(a.message),this.holes.push({dir:!0,
id:a.message.id}));this.pinned=a.pFlags?a.pFlags.pinned||!1:!1;this.notify=a.notify_settings?{show_priviews:a.notify_settings.show_priviews||!1,silent:a.notify_settings.silent||!1,mute_until:a.notify_settings.mute_until||-1,sound:a.notify_settings.sound||"def"}:null;"dialog"==a._&&(this.existInDialogs=!0);this.update()},listenDialog:function(a){var b=~~(99999*Math.random())+"";this.onDialogUpdate[b]=a;return b},forgetDialog:function(a){this.onDialogUpdate[a]&&delete this.onDialogUpdate[a]},listenMessages:function(a){var b=
~~(99999*Math.random())+"";this.onMessagesUpdate[b]=a;return b},forgetMessages:function(a){this.onMessagesUpdate[a]&&delete this.onMessagesUpdate[a]}}),dialogsCount=0,dialogs=[],peers={};function call(a,b,c){proto.sendAPIMethod(a,b,function(a,b){a||"AUTH_KEY_UNREGISTERED"!=b.error_message?c.apply(this,arr(arguments)):(Storage.remove("auth"),closeApp(),startIntro())})}proto.listenUpdates(receiveUpdates);
function receiveUpdates(a){pushUsers(a.users);pushChats(a.chats);if("updates"==a._){for(var b={},c={},d=0;d<a.updates.length;++d){var e=a.updates[d],g=e._.slice(6);if("NewMessage"==g){var f=peerID(e.message.to_id);b[f]||(b[f]=[]);b[f].push(e.message)}else if("DeleteMessages"==g)for(d=0;d<e.messages.length;++d)for(f in peers)peers[f].messages[e.messages[d]]&&(c[f]||(c[f]=[]),c[f].push(e.messages[d]));else processUpdate(e)}for(f in b)console.log(f),console.log(peers),peers[f].putMessages(b[f]);for(f in c)peers[f].deleteMessages(c[f])}else"updateShortChatMessage"==
a._?newmessage("c"+a.chat_id,a):"updateShortMessage"==a._?newmessage("u"+a.user_id,a):"updateShort"==a._&&processUpdate(a.update)}function processUpdate(a){"UserStatus"==a._.slice(6)&&users[a.user_id]&&(users[a.user_id].status=a.status,"function"!==typeof users[a.user_id].update?(console.error("WTF????????"),console.log(users[a.user_id],a)):users[a.user_id].update())}
function newmessage(a,b){peers[a]&&(0>["message","messageService","messageEmpty"].indexOf(b._)&&(b._="message"),peers[a].putMessages([b],!0))}function pushUsers(a){if(Array.isArray(a))for(var b=0;b<a.length;++b)users[a[b].id]||(users[a[b].id]=new User(a[b]))}function pushChats(a){if(Array.isArray(a))for(var b=0;b<a.length;++b)chats[a[b].id]||(chats[a[b].id]=new Chat(a[b]))}
function receiveDialogs(a,b,c){if(b){dialogsCount="messages.dialogsSlice"==c._?c.count:c.dialogs.length;pushUsers(c.users);pushChats(c.chats);for(var d=b=0;b<c.dialogs.length;++b){var e=c.dialogs[b],g=peerID(e.peer),f=g[0];parseInt(g.slice(1));if("u"==f)e.user=users[e.peer.user_id];else if("C"==f||"c"==f)f="c"==f?"chat":"channel",e[f]=chats[e.peer[f+"_id"]];e.message=find(c.messages,function(a){return a.id==e.top_message});peers[g]?(peer=peers[g],peer.updateAsDialog(e)):(peer=new Peer(e.peer,e),dialogs[d+
a]=peer.id,d++)}0==a&&clearDialogs();appendNewDialogs()}}function updateStatus(a){call("account.updateStatus",{offline:a?{_:"boolFalse"}:{_:"boolTrue"}},function(a,c){a?users[auth.user.id]&&(users[auth.user.id].status={_:"userStatusOnline"},users[auth.user.id].update()):console.warn("failed to update status")})};